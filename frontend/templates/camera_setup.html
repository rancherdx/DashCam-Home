{% extends "base.html" %}

{% block content %}
<div class="setup-container">
    <div class="skip-setup">
        <a href="/">Skip for now &raquo;</a>
    </div>
    <h1>Add Camera</h1>
    
    <div class="setup-tabs">
        <button class="tab-btn active" onclick="openTab('auto-tab')">Auto Setup</button>
        <button class="tab-btn" onclick="openTab('manual-tab')">Manual Setup</button>
        <button class="tab-btn" onclick="openTab('discover-tab')">Discover Cameras</button>
    </div>

    <!-- Auto Setup Tab -->
    <div id="auto-tab" class="tab-content active">
        <form id="auto-setup-form" class="setup-form">
            <div class="form-group">
                <label>Camera Name</label>
                <input type="text" name="name" placeholder="Front Door Camera" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>IP Address</label>
                    <input type="text" name="ip" placeholder="192.168.1.100" required>
                </div>
                <div class="form-group">
                    <label>ONVIF Port</label>
                    <input type="number" name="onvif_port" value="80" required>
                </div>
                <div class="form-group">
                    <label>RTSP Port</label>
                    <input type="number" name="rtsp_port" value="554" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" placeholder="Password" required>
                </div>
            </div>

            <div class="form-group">
                <label>Transport Protocol</label>
                <select name="transport">
                    <option value="tcp">TCP</option>
                    <option value="udp">UDP</option>
                </select>
            </div>

            <div class="form-group">
                <label>Camera Brand</label>
                <select name="brand">
                    <option value="">Select Brand</option>
                    <option value="hanwha">Hanwha/Samsung</option>
                    <option value="hikvision">Hikvision</option>
                    <option value="dahua">Dahua</option>
                    <option value="axis">Axis</option>
                    <option value="generic">Generic/Other</option>
                </select>
            </div>

            <button type="submit" class="btn-primary">Add Camera</button>
        </form>

        <div id="profile-selection" style="display: none;">
            <h3>Select a Stream Profile</h3>
            <div id="profile-list" class="profile-list"></div>
        </div>
    </div>

    <!-- Manual Setup Tab -->
    <div id="manual-tab" class="tab-content">
        <form id="manual-setup-form" class="setup-form">
            <div class="form-group">
                <label>Camera Name</label>
                <input type="text" name="name" placeholder="Custom Camera" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>IP Address / Hostname</label>
                    <input type="text" name="ip" placeholder="192.168.1.101" required>
                </div>
                <div class="form-group">
                    <label>RTSP Port</label>
                    <input type="number" name="rtsp_port" value="554" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password">
                </div>
            </div>

            <div class="form-group">
                <label>Stream Path</label>
                <input type="text" name="rtsp_path" placeholder="/stream1">
                <small class="form-help">e.g., /stream1, /cam/realmonitor?channel=1&subtype=0</small>
            </div>

            <div class="form-group">
                <label>Transport Protocol</label>
                <select name="transport">
                    <option value="auto">Auto</option>
                    <option value="tcp">TCP</option>
                    <option value="udp">UDP</option>
                </select>
            </div>

            <button type="submit" class="btn-primary">Add Camera</button>
        </form>
    </div>

    <!-- Discover Tab -->
    <div id="discover-tab" class="tab-content">
        <div class="discover-section">
            <h3>Discover ONVIF Cameras</h3>
            <p>Scan your network for ONVIF-compatible cameras</p>
            
            <button onclick="discoverCameras()" class="btn-primary" id="discover-btn">
                Start Discovery
            </button>

            <div id="discovery-results" class="discovery-results" style="display: none;">
                <h4>Discovered Cameras</h4>
                <div id="discovered-cameras-list" class="cameras-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const cameraId = urlParams.get('camera_id');

    if (cameraId) {
        document.querySelector('h1').textContent = 'Edit Camera';
        // Fetch camera data and populate form
        dashboard.apiFetch(`/api/cameras/${cameraId}`)
            .then(response => response.json())
            .then(camera => {
                // Determine which form to populate
                const formId = camera.manual_setup ? 'manual-setup-form' : 'auto-setup-form';
                const form = document.getElementById(formId);

                Object.keys(camera).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = camera[key];
                        } else {
                            input.value = camera[key];
                        }
                    }
                });

                // Show the correct tab
                openTab(camera.manual_setup ? 'manual-tab' : 'auto-tab');
            });
    }
});

function openTab(tabId) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    
    // Update active tab button
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
}

// Form submission handlers
document.getElementById('auto-setup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    const urlParams = new URLSearchParams(window.location.search);
    const cameraId = urlParams.get('camera_id');

    const method = cameraId ? 'PUT' : 'POST';
    const url = cameraId ? `/api/cameras/${cameraId}` : '/api/cameras';
    
    try {
        const response = await dashboard.apiFetch(url, {
            method: method,
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            fetchAndDisplayProfiles(result.camera_id);
        } else {
            const errorData = await response.json();
            alert('Error adding camera: ' + (errorData.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error adding camera: ' + error.message);
    }
});

document.getElementById('manual-setup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    const urlParams = new URLSearchParams(window.location.search);
    const cameraId = urlParams.get('camera_id');

    const method = cameraId ? 'PUT' : 'POST';
    const url = cameraId ? `/api/cameras/${cameraId}` : '/api/cameras/manual';
    
    try {
        const response = await dashboard.apiFetch(url, {
            method: method,
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            fetchAndDisplayProfiles(result.camera_id);
        } else {
            const errorData = await response.json();
            alert('Error adding camera: ' + (errorData.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error adding camera: ' + error.message);
    }
});

async function discoverCameras() {
    const btn = document.getElementById('discover-btn');
    btn.disabled = true;
    btn.textContent = 'Discovering...';
    
    try {
        const response = await dashboard.apiFetch('/api/discover', { method: 'POST' });
        const cameras = await response.json();
        
        const resultsDiv = document.getElementById('discovery-results');
        const listDiv = document.getElementById('discovered-cameras-list');
        
        listDiv.innerHTML = '';
        
        if (cameras.length === 0) {
            listDiv.innerHTML = '<p>No cameras found</p>';
        } else {
            cameras.forEach(cam => {
                listDiv.innerHTML += `
                    <div class="discovered-camera">
                        <strong>${cam.ip}:${cam.port}</strong>
                        <button onclick="addDiscoveredCamera('${cam.ip}', '${cam.port}')">Add</button>
                    </div>
                `;
            });
        }
        
        resultsDiv.style.display = 'block';
    } catch (error) {
        alert('Discovery failed: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Start Discovery';
    }
}

async function fetchAndDisplayProfiles(cameraId) {
    try {
        const response = await dashboard.apiFetch(`/api/onvif/profiles/${cameraId}`);
        if (!response.ok) {
            throw new Error('Failed to fetch profiles');
        }
        const profiles = await response.json();
        const profileList = document.getElementById('profile-list');
        profileList.innerHTML = '';

        if (profiles.length === 0) {
            profileList.innerHTML = '<p>No stream profiles found. You can still use the camera with its default settings.</p>';
        } else {
            profiles.forEach(profile => {
                profileList.innerHTML += `
                    <div class="profile-item">
                        <span>${profile.name} (${profile.width}x${profile.height}, ${profile.codec})</span>
                        <button onclick="selectProfile('${cameraId}', '${profile.token}')">Select</button>
                    </div>
                `;
            });
        }
        document.getElementById('profile-selection').style.display = 'block';
    } catch (error) {
        console.error('Error fetching profiles:', error);
        alert('Could not fetch stream profiles. The camera has been added with default settings.');
        window.location.href = '/';
    }
}

async function selectProfile(cameraId, profileToken) {
    try {
        const response = await dashboard.apiFetch(`/api/cameras/${cameraId}/profile`, {
            method: 'PUT',
            body: JSON.stringify({ profile_token: profileToken })
        });

        if (response.ok) {
            alert('Stream profile selected successfully!');
            window.location.href = '/';
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to select profile');
        }
    } catch (error) {
        console.error('Error selecting profile:', error);
        alert(`Error: ${error.message}`);
    }
}

function addDiscoveredCamera(ip, port) {
    document.querySelector('[name="ip"]').value = ip;
    document.querySelector('[name="onvif_port"]').value = port;
    openTab('auto-tab');
}
</script>

<style>
.skip-setup {
    text-align: right;
    margin-bottom: 15px;
}
.skip-setup a {
    color: #666;
    text-decoration: none;
}
.skip-setup a:hover {
    text-decoration: underline;
}
.setup-tabs {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 2px solid #ddd;
}

.tab-btn {
    padding: 10px 20px;
    border: none;
    background: none;
    cursor: pointer;
    border-bottom: 3px solid transparent;
}

.tab-btn.active {
    border-bottom-color: #3498db;
    color: #3498db;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.setup-form {
    max-width: 600px;
}

.form-row {
    display: flex;
    gap: 15px;
}

.form-row .form-group {
    flex: 1;
}

.form-help {
    color: #666;
    font-size: 12px;
}

.discovery-results {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 5px;
}

.discovered-camera {
    padding: 10px;
    margin: 5px 0;
    background: white;
    border-radius: 3px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
</style>
{% endblock %}